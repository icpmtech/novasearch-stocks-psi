<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Gainers & Losers</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/i18next@22.4.11/dist/umd/i18next.min.js"></script>
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; margin: 0; padding: 0; }
    header { background: #222; padding: 20px; text-align: center; color: #0ff; position: relative; }
    .lang-switch { position: absolute; top: 10px; right: 10px; }
    .lang-switch button { margin: 0 3px; padding: 5px 10px; background: #444; color: #fff; border: none; cursor: pointer; }
    .charts-container { display: flex; flex-wrap: wrap; justify-content: space-around; padding: 20px; }
    .chart-box { background: #1a1a1a; padding: 20px; margin: 10px; flex: 1 1 45%; border-radius: 10px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; background: #222; }
    th, td { padding: 10px; border: 1px solid #444; text-align: center; }
    th { background: #333; }
    @media (max-width: 768px) { .chart-box { flex: 1 1 100%; } }
  </style>
</head>
<body>
  <header>
    <div class="lang-switch">
      <button onclick="changeLang('pt')">PT</button>
      <button onclick="changeLang('en')">EN</button>
    </div>
    <h1 data-i18n="dashboard_title">Dashboard de Ações</h1>
  </header>

  <div class="charts-container">
    <div class="chart-box">
      <h2 data-i18n="top_gainers">Top Ganhadores</h2>
      <div id="gainersChart"></div>
    </div>
    <div class="chart-box">
      <h2 data-i18n="top_losers">Top Perdedores</h2>
      <div id="losersChart"></div>
    </div>
  </div>

  <div class="chart-box" style="margin: 20px;">
    <h2 data-i18n="full_table">Tabela Completa</h2>
    <table id="stocksTable">
      <thead>
        <tr>
          <th data-i18n="ticker">Ticker</th>
          <th data-i18n="name">Nome</th>
          <th data-i18n="change">Variação</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API_KEY = "LQA8H3ISM6DV6H8Q";
    const stocks = [
      { ticker: "AAPL", name: "Apple Inc" },
      { ticker: "MSFT", name: "Microsoft" },
      { ticker: "GOOGL", name: "Alphabet" },
      { ticker: "AMZN", name: "Amazon" },
      { ticker: "TSLA", name: "Tesla" },
      { ticker: "NVDA", name: "NVIDIA" },
      { ticker: "META", name: "Meta Platforms" },
      { ticker: "INTC", name: "Intel" },
      { ticker: "BABA", name: "Alibaba" },
      { ticker: "NFLX", name: "Netflix" }
    ];

    async function fetchData() {
      const results = [];

      for (let i = 0; i < stocks.length; i++) {
        const stock = stocks[i];
        try {
          const res = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${stock.ticker}&apikey=${API_KEY}`);
          const json = await res.json();

          if (!json["Time Series (Daily)"]) continue;

          const daily = json["Time Series (Daily)"];
          const dates = Object.keys(daily).sort((a, b) => new Date(b) - new Date(a));
          const todayClose = parseFloat(daily[dates[0]]["4. close"]);
          const prevClose = parseFloat(daily[dates[1]]["4. close"]);
          const change = ((todayClose - prevClose) / prevClose) * 100;

          results.push({ ...stock, change });
        } catch (e) {
          console.warn("Erro ao buscar", stock.ticker, e);
        }

        await new Promise(r => setTimeout(r, 15000)); // Delay entre chamadas
      }

      render(results);
    }

    function render(data) {
      const sorted = [...data].sort((a, b) => b.change - a.change);
      const gainers = sorted.slice(0, 5);
      const losers = sorted.slice(-5).reverse();

      Plotly.newPlot("gainersChart", [{
        x: gainers.map(s => s.ticker),
        y: gainers.map(s => s.change),
        type: 'bar',
        marker: { color: 'lime' }
      }], {
        paper_bgcolor: '#1a1a1a',
        plot_bgcolor: '#1a1a1a',
        font: { color: '#fff' },
        title: 'Top Gainers (%)'
      });

      Plotly.newPlot("losersChart", [{
        x: losers.map(s => s.ticker),
        y: losers.map(s => s.change),
        type: 'bar',
        marker: { color: 'red' }
      }], {
        paper_bgcolor: '#1a1a1a',
        plot_bgcolor: '#1a1a1a',
        font: { color: '#fff' },
        title: 'Top Losers (%)'
      });

      const tbody = document.querySelector("#stocksTable tbody");
      tbody.innerHTML = "";
      data.forEach(s => {
        tbody.innerHTML += `
          <tr>
            <td>${s.ticker}</td>
            <td>${s.name}</td>
            <td style="color:${s.change >= 0 ? 'lime' : 'red'}">${s.change.toFixed(2)}%</td>
          </tr>`;
      });
    }

    const resources = {
      pt: {
        translation: {
          dashboard_title: "Dashboard de Ações",
          top_gainers: "Top Ganhadores",
          top_losers: "Top Perdedores",
          full_table: "Tabela Completa",
          ticker: "Ticker",
          name: "Nome",
          change: "Variação"
        }
      },
      en: {
        translation: {
          dashboard_title: "Stock Dashboard",
          top_gainers: "Top Gainers",
          top_losers: "Top Losers",
          full_table: "Full Table",
          ticker: "Ticker",
          name: "Name",
          change: "Change"
        }
      }
    };

    i18next.init({ lng: 'pt', resources }, () => updateTexts());
    function changeLang(lang) {
      i18next.changeLanguage(lang, updateTexts);
    }

    function updateTexts() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        el.textContent = i18next.t(el.getAttribute("data-i18n"));
      });
    }

    fetchData();
  </script>
</body>
</html>
